<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>STEMChat</title>
  <link rel="shortcut icon" href="/favicon.ico">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="/js/jquery.min.js"></script>
  <link rel="stylesheet" href="/css/quill.css">
  <link href="/css/bootstrap.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/chat.css">
</head>

<body>
  <div style="display: none;" id="curr_user" name='<%=curr_user.username%>'>
  </div>
  <div style="display: none;" id="curr_user_id" name='<%=curr_user.id%>'>
  </div>
  <div style="display: none;" id="url" name='<%=url%>'>
  </div>
  <div style="display: none;" id="tid"></div>
  <div style="display: none;" id="page_url" name='<%=page_url%>'></div>
  <div style="display: none;" id="posts_count" name='<%=topic_data.posts_count%>'></div>
  <div style="display: none;" id="specific_posts_page" name='<%=specific_posts_page%>'></div>
  <div style="display: none;" id="category_details" data-slug="" data-title=""></div>

  <!--<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet">-->
  <link href="/css/font-awesome.min.css" rel="stylesheet">
  <div class="container">
    <div id="mySidebar" class="sidebar">

      <a href="/">Home</a>
      <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">‚úñ</a>

      <a href='<%=about%>'>About</a>
      <a href='<%=home%>'>Chat</a>
      <a href='<%=blog%>'>Blogs</a>
      <a href='<%=project%>'>Projects</a>

      <a href='<%=feedback%>'>Feedback</a>
      <a href='<%=profile%>'>Profile</a>

      <a href="<%=logout%>">Logout</a>


    </div>

    <div class="panel messages-panel">
      <div class="contacts-list">
        <div class="header">
          <button class="openbtn" onclick="openNav()">‚ò∞</button>
        </div>
        <div class="inbox-categories" style="display: none;">

          <div data-toggle="tab" data-target="#inbox" class="active _right" id="new_message"
            class="btn btn btn-success new-message"> <i class="fa fa-envelope"></i> </div>

        </div>
        <div class="dropdown-menu_">
          <button id="menu_active" class="menu-btn">Categories</button>
          <div class="top_header_search_box"><input style="display: none" type="text" id="myInput" onkeyup="myFunc()" name="search" placeholder="Search"><i id="search_icon" class="fa fa-search icon"></i></div>
          <div class="menu-content">
            <div id="private_click" class="pointer links" onClick='function_pvt()'>
              <li id="private" class="" data-toggle="" data-target="">
                <h4 class="menu_move">
                  <i class="fa fa-user dropdown-content1" aria-hidden="true"></i>
                  Private Messages</h4>
              </li>
            </div>
            <div id="group_click" class="pointer links" onClick='function_category()'>
              <li id="group" class="" data-toggle="" data-target="">
                <h4 class="menu_move">
                  <i style="font-size:24px" class="fa dropdown-content2">&#xf0c0;</i>
                  Groups</h4>
              </li>
            </div>
            <div id="category_click" class="pointer links" onClick='function_category_common()'>
              <li id="category" class="" data-toggle="" data-target="">
                <h4 class="menu_move">
                  <i class="fa fa-list-alt dropdown-content3" aria-hidden="true"></i>

                  Categories</h4>
                <h5>
                </h5>
              </li>
            </div>

          </div>
        </div>
        <div class="tab-content">


          <div id="inbox" class="contacts-outter-wrapper tab-pane active">
<!--             <div class="im_diaglog_search">
            <file class="panel-search-form info form-group has-feedback no-margin-bottom">
              <div id="search_box" class="input-icons"> 
                <i class="fa fa-search icon"> 
                </i> 
              <input type="text" id="myInput" onkeyup="myFunc()" class="form-control input-field" name="search"
                placeholder="Search">
              <span class="fa fa-search form-control-feedback"></span>
              </div>
            </form> 
            </div> -->

            <div class="contacts-outter">

              <ul id="myUL" class="list-unstyled contacts">




                <div id="holder2">


                </div>
                <div id="holder4">


                </div>
                <div id="holder5">


                </div>
                <div id="holder6">


                </div>
                <div id="holder7">

                  <%if(page_url == "topic"){%>
                  <div><li id="<%= topic_data.title%>" class="active" data-toggle="tab" data-target="#inbox-message-0"><div class="message-count"><%= topic_data ? topic_data.posts_count : "0" %></div><img alt="" class="img-circle medium-image" src="https://bootdey.com/img/Content/avatar/avatar1.png"><div class="vcentered info-combo"><h3 class="no-margin-bottom name"><b><%= topic_data.title%></b> </h3><h5>Latest post by:<%=topic_data.details.last_poster.username%></h5></div><div class="contacts-add">
                    <span class="message-time">
                    <%var year_month = topic_data.last_posted_at.split("T")[0];time = topic_data.last_posted_at.split("T")[1]; %>
                      <%= year_month.split("-")[2]+"/"+year_month.split("-")[1] %><br>
                      <%= time.split(":")[0]+":"+time.split(":")[1] %>
                    <sup></sup></span><i class="fa fa-trash-o"></i><div><i class="fa fa-share-alt "></i> </div></div></li></div>
                  <%}%>
                </div>
                <div id="holder8" style="display:none;"></div>
              </ul>
            </div>

          </div>

        </div>
      </div>

      <div class="tab-content">
        <div class="tab-pane message-body" id="inbox-message-1">
          <div class="message-top">
            <center>
              <div id="slug">
                <%if(page_url == "topic"){%> <h4 id="topic_head">  <%if(topic_data){%> <%=topic_data.title%> <%}%> </h4> <%}%>
              </div>
            </center>

            <button id="back_" class="mobile_backbtn" onclick="my_func2()">‚¨ÖÔ∏è Back</button>
            <div class="new-message-wrapper">
              <div class="form-group">
                <input type="text" class="form-control" placeholder="Send message to...">
                <a class="btn btn-danger close-new-message" href="#"><i class="fa fa-times"></i></a>
              </div>

              <div class="chat-footer new-message-textarea">
                <textarea class="send-message-text"></textarea>
                <label class="upload-file">
                  <input type="file" required="">
                  <i class="fa fa-share-alt"></i>
                </label>
                <button type="button" class="send-message-button btn-info"> <i class="fa fa-send"></i> </button>
              </div>
            </div>
          </div>

          <div class="message-chat">
            <div id="chat_" class="chat-body">
              <%if(topic_data && topic_data.post_stream && (topic_data.post_stream.posts[0].post_number != post_number ) && post_number != "" ){%>
                <button style="display: block" id="load_previous_posts" onclick="load_more(this)">Load Previous Posts</button>
              <% } else if(page_url!="topic" || page_url=="topic"){ %>
                <button style="display: block" id="load_previous_posts" onclick="load_more(this)">Load Previous Posts</button>
              <%}%>
              <div id="holder3">
                <%if(topic_data){%>
                <% var temp = false %>
                <% var display = 'style=display:none;' %>
                <textarea id="post_ids" style="display: none;">
                  <%= topic_data.post_stream.stream.slice(  (20* ((Math.ceil((topic_data.post_stream.stream.indexOf((Number(topic_data.post_stream.posts[0].id)))-1) / 20)-1)  )) ,(Number(topic_data.post_stream.stream.indexOf((Number(topic_data.post_stream.posts[0].id)))+1) -1)  )%>
                  </textarea>
                <%for(var i=0;i<topic_data.post_stream.posts.length;i++){%>
                <% var page_number = Math.ceil((topic_data.post_stream.stream.indexOf((Number(topic_data.post_stream.posts[i].id)))+1) / 20) %>
                <%if( temp == false && post_number!="" && topic_data.post_stream.posts[i].post_number.toString() != post_number ){%>
                  <% display = 'style=display:none;' %>
                <%} else {%>
                  <% display = 'style=display:block;' %>
                  <% temp= true %>
                <%}%>
                <div <%= display %> id="msg_<%= topic_data.post_stream.posts[i].topic_id%>_<%= topic_data.post_stream.posts[i].post_number%>_<%= topic_data.posts_count%>_<%= page_number%>" data-post_id="<%=topic_data.post_stream.posts[i].id%>" data-count="<%=topic_data.post_stream.stream.indexOf((Number(topic_data.post_stream.posts[i].id)))+1%>" data-page_number="<%=page_number %>" class="message <%= topic_data.post_stream.posts[i].username === curr_user.username ? 'my-message' : 'my-info' %>">
                  <!-- <img alt="" class="img-circle medium-image" src="<%=url%>user_avatar/<%=url.substring(9)%>/<%=topic_data.post_stream.posts[i].username%>/120/671_2.png"> --><div class="message-body"><div class="message-body-inner"><div class="message-info"><b><%=topic_data.post_stream.posts[i].username%></b> <i id="reply_btn_<%= topic_data.post_stream.posts[i].topic_id%>_<%= topic_data.post_stream.posts[i].post_number%>" type="button" class="fa fa-reply reply_function" title="<%=topic_data.post_stream.posts[i].cooked%>"></i>
                    <button id="share_btn_<%= topic_data.post_stream.posts[i].topic_id%>_<%= topic_data.post_stream.posts[i].post_number%>_<%= topic_data.post_stream.posts[i].id%>" type="button" data-tslug="<%=topic_data.slug%>" title="share a link to this post" onclick="share_function(this)">Share</button>
                    <%if(topic_data.post_stream.posts[i].username === curr_user.username){%>
                    <button id="delete_btn_<%= topic_data.post_stream.posts[i].topic_id%>_<%= topic_data.post_stream.posts[i].post_number%>_<%= topic_data.post_stream.posts[i].id%>" type="button" data-tslug="<%= topic_data.slug%>" onclick="delete_function(this)">Delete</button>
                    <%}%>
                  </div><hr><div class="message-text"><%- topic_data.post_stream.posts[i].cooked%></div></div>
                  <%if(Number(topic_data.post_stream.posts[i].reply_count) > 0 && topic_data.post_stream.posts[i+1] && (topic_data.post_stream.posts[i].post_number != topic_data.post_stream.posts[i+1].reply_to_post_number) ) {%>
                  <button id="msg_<%= topic_data.post_stream.posts[i].topic_id%>_<%= topic_data.post_stream.posts[i].post_number%>_<%= topic_data.posts_count%>_<%= page_number%>" data-post_id="<%=topic_data.post_stream.posts[i].id%>" type="button" class="see_replies"> <%= topic_data.post_stream.posts[i].reply_count%>
                    <%= (Number(topic_data.post_stream.posts[i].reply_count) == 1 ? ' Reply': ' Replies') %> </button>
                  <%}%>
                  <% var if_block=false %>
                  <%if(topic_data.post_stream.posts[i].actions_summary.length > 0){%>
                    <%for(var j=0;j<topic_data.post_stream.posts[i].actions_summary.length;j++){%>
                      <%if(topic_data.post_stream.posts[i].actions_summary[j].count) {%>
                      <span id="like_count_<%= topic_data.post_stream.posts[i].id%>" style="display: inline-block;"><%=topic_data.post_stream.posts[i].actions_summary[j].count %></span>
                      <% if(topic_data.post_stream.posts[i].username != curr_user.username) {%>
                      <a id="like_icon_<%= topic_data.post_stream.posts[i].id%>" onclick="like_function(this,'/post_actions/<%= topic_data.post_stream.posts[i].id %>/2')"><i class="fa fa-heart"></i></a>
                      <% } else {%>
                      <a id="like_icon_<%= topic_data.post_stream.posts[i].id%>"><i style="color: red;" class="fa fa-heart"></i></a>
                      <%}%>
                      <% if_block = true %>
                      <% break; %>
                      <%}%>
                    <%}%>
                  <%}%>
                  <% if(if_block == false && topic_data.post_stream.posts[i].username != curr_user.username) {%>
                      <span id="like_count_<%= topic_data.post_stream.posts[i].id%>" style="display: inline-block;"></span>
                      <a id="like_icon_<%= topic_data.post_stream.posts[i].id%>" onclick="like_function(this,'/post_actions/<%= topic_data.post_stream.posts[i].id %>/2')"><i class="fa fa-heart"></i></a>
                  <%} else if(if_block == false && topic_data.post_stream.posts[i].username == curr_user.username) {%>
                      <span id="like_count_<%= topic_data.post_stream.posts[i].id%>" style="display: inline-block;"></span>
                      <a id="like_icon_<%= topic_data.post_stream.posts[i].id%>"><i style="color: red;" class="fa fa-heart"></i></a>
                  <%}%>
                  <%var message_datetime = new Date(topic_data.post_stream.posts[i].updated_at).toLocaleString([], { hour: '2-digit', minute: '2-digit' , day: '2-digit', month: '2-digit', year: '2-digit'}).split("/");
                  message_datetime = message_datetime[1]+"/"+message_datetime[0]+"/"+message_datetime[2];%>
                  <%= message_datetime%>
                </div><br>
                </div>
                <%}%>
                <%}%>
              </div>
              <%if(topic_data && topic_data.post_stream.posts && topic_data.post_stream.posts[19]!=undefined ){%>
              <button id="load_next_posts" style="display: none" onclick="load_next_posts(this)">Load Next Posts</button>
              <% var indexoflastpostid = (topic_data.post_stream.stream.indexOf((Number(topic_data.post_stream.posts[19].id)))) %>
              <textarea id="next_post_ids" style="display: none;">
                <%= topic_data.post_stream.stream.slice(  Number(indexoflastpostid) +1 , (Math.ceil(Number((indexoflastpostid+1)/20)) *20)  )%>
              </textarea>
              <%}%>
            </div>
<!--             <center>
              <div>
              
              <div class="chat-footer">
                <button type="button" name="show_toolbar" id="show_toolbar" style="display: none;">üëá</button>
                <button type="button" name="hide_toolbar" id="hide_toolbar" style="display:none;">üëÜ</button>
                <div contenteditable="true" class="edit" id='editor'></div>
                <textarea id="temp_editor" class="send-message-text"></textarea>
                <textarea id="temp_editor" class="send-message-text"></textarea>
                <form class="" action='/reply' method="post" id='reply_form'>
                  <input type="text" name="body" value="" id='reply_data' style="display: none;">
                  <button type="button" name="post" id='saveDelta' class="send-message-button btn-info"> <i
                      class="fa fa-send"></i></button>
                </form>

              </div>
            </div>

            </center> -->
          </div>
            <%if (false) {%>
            <div class="chat_section" style="position:fixed; bottom: 0;width:75%;resize: both;overflow: auto;"> 
            <div class="display_replies"><p class="selected_msg"></p></div>

            <div class="inputWithIcon inputIconBg">
              <textarea id="replyMessage" type="text"  class="replyMessage" data-autosize-input='{ "space": 40 }' placeholder="Type your message..."/></textarea>
                
                <button class="replyBtn">

                <input type="file" name="upload_files" id="upload_files" multiple  style="display:none"/>
                <i class="fa fa-paperclip fa-2x" id="openFileUpload"  aria-hidden="true" >

                </i>
                </button>

                <button type="button" name="post" id='saveDelta' class="toolButtons" style="position:fixed; margin-top:-3px;">
                  <i class="fa fa-paper-plane fa-2x" aria-hidden="true"></i>
                </button>

            </div>



          </div>
          <%}%>
          <div class="display_replies"><p class="selected_msg"></p></div>
          <div class="editor_widget">
            <div class="im_attach pull-left">
              <input id="upload_files" type="file" multiple="multiple" title="Send file" class="im_attach_input">
              <i class="fa fa-paperclip fa-2x" aria-hidden="true"></i>
            </div>

            <div id="replyMessage" class="composer_rich_textarea" dir="auto" style="padding-left: 16px; padding-right: 16px;" placeholder="Start the conversation..." contenteditable="true"></div>

            <div class="im_attach pull-right">
              <button id="saveDelta" class="save_btn" type="button" title="Submit"></button>
              <i class="fa fa-paper-plane fa-2x" aria-hidden="true"></i>
            </div>
          </div>

        </div>
      </div>




      </div>
    </div>
  </div>
  <div id="myModal" class="modal">

    <!-- Modal content -->
    <div class="modal-content">
      <span style="cursor:pointer" class="closes">‚úñ</span>
      <center>
        <h1 class="head_">Start discussion</h1>
        <form action="/chatpost" method="POST" id='pvt_msg_form'>

          <input type="text" name="title" required='' autocomplete="off" placeholder="Title"> <br>
          <textarea name="desc" required='' autocomplete="off" placeholder="Description"></textarea> <br>

          <input type="text" name="user_search" placeholder="Add User" list="users1" autocomplete="off" required=''>
          <datalist id='users1'>

          </datalist>
          <br>

          <p align="right">
            <button id="saveDelta" class="button-secondary" type="submit" id='on_but' name="compose">Compose</button>
          </p>
        </form>
      </center>

    </div>

  </div>

  <script type="text/javascript">
        
    $('textarea').on('keydown', function(e){
         if(e.which == 13) {
           e.preventDefault();
         }
       }).on('input', function(){
         $(this).height(1);
           var totalHeight = $(this).prop('scrollHeight') - parseInt($(this).css('padding-top')) - parseInt($(this).css('padding-bottom'));
         $(this).height(totalHeight);
     });

    // $('textarea').each(function () {
    //   this.setAttribute('style', 'height:' + (this.scrollHeight) + 'px;overflow-y:hidden;');
    // }).on('input', function () {
    //   this.style.height = 'auto';
    //   this.style.height = (this.scrollHeight) + 'px';
    // });

    // te = document.querySelector('textarea');
    // te.addEventListener('keyup', resizeTextarea);

    // function resizeTextarea(ev) {
    //     this.style.height = '24px';
    //     this.style.height = this.scrollHeight + 12 + 'px';
    // }

      // expandtextarea(document.querySelector('.js-expand'));


      // function expandtextarea(container) {
      //   var tarea = container.querySelector('textarea');
      //   var mirror = container.querySelector('span');
      //   tarea.addEventListener('input', function(e) {
      //     mirror.textContent = tarea.value;
      //   });
      // }

  </script>

  <script src="http://netdna.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
  <script type="text/javascript">
    var myUrl=$('#url').attr('name');
    myUrl=myUrl.substring(0,myUrl.length-1);
  </script>
  <script src="/js/chat.js" charset="utf-8"></script>
  <script src="/js/quill.js"></script>
  <script>
  //Editor and posting

      function test_function(){
        alert("test_function");
      }
      // document.getElementById('editor').style.display = "none";
      function showDiv() {
        // $(".chat-body").animate({ scrollTop: $('.chat-body').prop("scrollHeight") }, 1000);
        //  alert("hi");
        $(".chat-footer").css('height', "30%");
        $(".chat-body").css('height', "70vh");
        // alert("hello");

        document.getElementById('editor').style.display = "inline-block";
        document.getElementById('temp_editor').style.display = "none";
        $('#show_toolbar').show();
        //document.querySelector('.ql-toolbar.ql-snow').style.display = "inline-block";
      }

      $('#show_toolbar').click(() => {
        $('#show_toolbar').hide();
        $('#hide_toolbar').show();
        document.querySelector('.ql-toolbar.ql-snow').style.display = "inline-block";
      });
      $('#hide_toolbar').click(() => {
        $('#hide_toolbar').hide();
        $('#show_toolbar').show();
        document.querySelector('.ql-toolbar.ql-snow').style.display = "none";
      });
      var options = [
        ['bold', 'italic', 'underline', 'strike'],
        ['blockquote', 'code-block'],
        [{ 'header': 1 }, { 'header': 2 }],
        [{ 'list': 'ordered' }, { 'list': 'bullet' }],
        [{ 'script': 'sub' }, { 'script': 'super' }],
        [{ 'indent': '-1' }, { 'indent': '+1' }],
        [{ 'direction': 'rtl' }],
        [{ 'color': [] }, { 'background': [] }],
        [{ 'font': [] }],

        ['link', 'image', 'video']
      ];


      // var quill = new Quill('#editor', {
      //   modules: {
      //     toolbar: options,

      //   },
      //   placeholder: "Type your message",
      //   scrollingContainer: '#editor',
      //   theme: 'snow'
      // });
      document.getElementById('saveDelta').addEventListener('click', function () {
        var body = document.getElementById('replyMessage');
        var topic_title = document.getElementById("topic_title");
        // console.log(topic_title);
        var reply_message = document.getElementsByClassName('selected_msg');
        // console.log(reply_message[0]);
        var topic_id = $('#tid').attr('name');
        var topic_slug = $('#slug').attr('name');
        // console.log(reply_message.length);
        // console.log(reply_message[0].id);
        if (reply_message !=null && reply_message !=undefined && reply_message.length > 0 && reply_message[0].id!=null && reply_message[0].id!=undefined && reply_message[0].id!="" && body!=undefined && body.innerHTML!=undefined){
          let fields = reply_message[0].id.split('_');
          topic_id = fields[2];
          let reply_to_post_number = fields[3];
          // console.log(reply_to_post_number);
          // reply_message = reply_message.innerHTML.split("<button");
          let raw = body.innerHTML;
          category_id = 0;
          let url = '/reply/' + topic_id + '/' + category_id  + '/' + reply_to_post_number; 
          // console.log(url);
          $.ajax(url,{
          type:'POST',
          data:{
            raw:raw,
          },
          success:function (data,status,xhr) {   // success callback function
            setTimeout(function(){
              $('#holder3').html('');
              $('.pointer.links.active-tab').click();
              body.innerHTML='';
              // reply_message[0].innerHTML='';
              $('.display_replies').empty();
              // console.log(document.getElementById("topic_head"));
              let topic_head = document.getElementById("topic_head")
              if(topic_head!=null && topic_head!=undefined){
                topic_head = topic_head.innerHTML;
              }
              load_posts(topic_slug+'/'+topic_id+'/'+(Number(reply_to_post_number)+1),topic_head);
              setTimeout(()=>{
                    // $(".chat-body").animate({ scrollTop: $('.chat-body').prop("scrollHeight") }, 500);
              },500);
            },1000);
          },
          error:function(jqXhr, textStatus, errorMessage){alert('Failed to send message '+ errorMessage);}
          });
        }
        else if(topic_title!=null && topic_title!= undefined && topic_title.innerHTML !=null && topic_title.innerHTML !=undefined && topic_title.innerHTML!=""){
          // console.log(body.value);
          // console.log(topic_title.value);
          var searched_user = document.getElementById("searched_user");
          var category_id = document.getElementById("select_category_id");
          if ( category_id!=null && category_id != undefined ){
            category_id = category_id.value
          }
          // console.log(category_id);
          let url = "/chatpost"
          $.ajax(url,{
            type:'POST',
            data:{
              title: topic_title.value,
              desc: body.value,
              user_search: searched_user.value,
              category: category_id
            },
            success:function (data,status,xhr) {   // success callback function
              // console.log(data);
              document.getElementById("replyMessage").value="";
              document.getElementById("topic_title").value="";
              setTimeout(function(){
                if(searched_user && searched_user.value == $("#curr_user").attr("name")){
                  document.getElementById("category_click").click();
                }
                else{
                  document.getElementById("private_click").click();
                }
                document.getElementById("inbox-message-1").style.display = "None";
                $("#topic_head").html("");
                $("#holder3").html("");
              },1500);
           },
            error:function(jqXhr, textStatus, errorMessage){alert('Failed to send message '+ errorMessage);}
          });
        }
        else if(body && body.innerHTML!=undefined && body.innerHTML!=null){
          var url = '/reply/' + topic_slug + '/' + topic_id;
          $.ajax(url,{
            type:'POST',
            data:{
              slug:topic_slug,
              tid:topic_id,
              body:body.innerHTML
            },
            success:function (data,status,xhr) {   // success callback function
              // console.log(data);
              body.innerHTML="";
              setTimeout(function(){
                // $('#holder3').html('');
                // $('.pointer.links.active-tab').click();
                let topic_head = document.getElementById("topic_head")
                if(topic_head!=null && topic_head!=undefined){
                  topic_head = topic_head.innerHTML;
                }
                load_posts(topic_slug+'/'+topic_id+'/9999',topic_head);
                // setTimeout(()=>{
                //       $(".chat-body").animate({ scrollTop: $('.chat-body').prop("scrollHeight") }, 500);
                // },500);
              },1000);
           },
            error:function(jqXhr, textStatus, errorMessage){alert('Failed to send message '+ errorMessage);}
          });
        }
      });


    $('#upload_files').change(function(event){
      var input = this;
      var url = $(this).val();
      var ext = url.substring(url.lastIndexOf('.') + 1).toLowerCase();

      topic_id = input.dataset.topic_id;
      url = "/upload/"+topic_id;
      var file = event.target.files[0];

      reader = new FileReader();

      reader.onloadend = function () {
        var b64 = reader.result.replace(/^data:.+;base64,/, '');

        $.ajax(url,{
          type:'POST',
          data: {file:b64,filename:file.name},

          success:function (data,status,xhr) {   // success callback function
            // console.log(data);
            if(data && data.error!=null){
              alert(data.error);
            }
            else{
              $("#replyMessage").html($("#replyMessage").html() + data);
            }
         },
          error:function(jqXhr, textStatus, errorMessage){alert('Failed to upload file '+ errorMessage);}
        });
      };

      reader.readAsDataURL(file);

      });

      $('#openFileUpload').click(function(){ $('#upload_files').trigger('click'); });


  </script>
</body>

</html>
